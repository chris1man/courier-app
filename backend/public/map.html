<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Карта курьеров</title>
  <link rel="stylesheet" href="/leaflet.css" />
  <style>
    body { margin: 0; padding: 0; }
    #map { height: 100vh; width: 100vw; }
    .legend { position: absolute; top: 10px; left: 10px; background: white; padding: 10px; border: 1px solid #ccc; z-index: 1000; }
    .legend-item { display: flex; align-items: center; margin-bottom: 5px; }
    .legend-color { width: 20px; height: 20px; border-radius: 50%; margin-right: 10px; }
    .leaflet-popup-content { font-family: 'Montserrat', sans-serif; }
    .route-button { padding: 5px 10px; background: #e73a62; color: white; border: none; border-radius: 5px; cursor: pointer; }
    .route-button:hover { background: #c32f52; }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="legend" class="legend"></div>
  <script src="/leaflet.js"></script>
  <script>
    const savedCenter = JSON.parse(localStorage.getItem('mapCenter')) || [56.4846, 84.9476];
    const savedZoom = parseInt(localStorage.getItem('mapZoom')) || 12;
    const map = L.map('map').setView(savedCenter, savedZoom);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    const markers = {};
    let couriers = {};
    const courierColors = {
      "danil": "#FF0000",
      "katya": "#0000FF",
      "sasha": "#008000",
      "pasha": "#FFA500",
      "timur": "#800080",
      "vladimir": "#8B0000",
      "alex": "#00008B",
      "testcourier": "#00FFFF"
    };

    function getCourierIcon(color) {
      return L.divIcon({
        html: `<div style="background-color: ${color}; width: 20px; height: 20px; border-radius: 50%; border: 2px solid white;"></div>`,
        className: 'courier-icon',
        iconSize: [20, 20],
        iconAnchor: [10, 10]
      });
    }

    function updateLegend() {
      const legend = document.getElementById('legend');
      legend.innerHTML = '';
      Object.values(couriers).forEach(({ name, color }) => {
        const item = document.createElement('div');
        item.className = 'legend-item';
        item.innerHTML = `<div class="legend-color" style="background-color: ${color};"></div>${name}`;
        legend.appendChild(item);
      });
    }

    async function fetchOrders(login, lat, lng) {
      console.log(`Запрос заказов для ${login} на ${lat}, ${lng}`);
      try {
        const response = await fetch(`/api/courier-orders/${login}`);
        if (!response.ok) throw new Error(`HTTP error: ${response.status}`);
        const data = await response.json();

        if (!data.orders || data.orders.length === 0) {
          return `Курьер: ${login}<br>Активных заказов нет`;
        }

        let popupContent = `Курьер: ${login}<br>`;
        data.orders.forEach(order => {
          const address = order.address;
          const time = order.deliveryTime;
          const routeUrl = `https://yandex.ru/maps/?rtext=${lat},${lng}~${encodeURIComponent(`Томск, ${address}`)}&rtt=auto`;
          popupContent += `${address} - ${time} - <button class="route-button" onclick="window.open('${routeUrl}', '_blank')">Маршрут</button><br>`;
        });

        popupContent += `<small>*Время прибытия примерное, зависит от трафика</small>`;
        return popupContent;
      } catch (error) {
        console.error('Ошибка получения заказов:', error);
        return `Курьер: ${login}<br>Ошибка загрузки заказов: ${error.message}`;
      }
    }

    map.on('moveend zoomend', () => {
      const center = map.getCenter();
      localStorage.setItem('mapCenter', JSON.stringify([center.lat, center.lng]));
      localStorage.setItem('mapZoom', map.getZoom());
    });

    const ws = new WebSocket('wss://makiapp.ru/ws?type=map');

    ws.onopen = () => {
      console.log('Подключено к WebSocket для карты');
      setInterval(() => ws.send('ping'), 10000);
    };

    ws.onmessage = (event) => {
      if (event.data === 'pong') return;
      const { type, data } = JSON.parse(event.data);
      if (type === 'locations') {
        Object.keys(markers).forEach(login => {
          if (!data[login]) {
            map.removeLayer(markers[login]);
            delete markers[login];
          }
        });
        Object.entries(data).forEach(([login, { lat, lng }]) => {
          const normalizedLogin = login.toLowerCase();
          const color = couriers[normalizedLogin]?.color || courierColors[normalizedLogin] || '#808080';
          console.log(`Обновление маркера для ${normalizedLogin}, цвет: ${color}`);
          if (markers[login]) {
            markers[login].setLatLng([lat, lng]);
          } else {
            markers[login] = L.marker([lat, lng], { icon: getCourierIcon(color) })
              .addTo(map)
              .on('click', () => {
                console.log(`Клик по маркеру ${normalizedLogin}`);
                fetchOrders(normalizedLogin, lat, lng).then(content => {
                  console.log(`Получен контент для ${normalizedLogin}: ${content}`);
                  markers[login].bindPopup(content).openPopup();
                }).catch(error => {
                  console.error(`Ошибка при загрузке заказов для ${normalizedLogin}:`, error);
                  markers[login].bindPopup(`Ошибка: ${error.message}`).openPopup();
                });
              });
          }
        });
      } else if (type === 'couriers') {
        data.forEach(({ name, color }) => {
          couriers[name.toLowerCase()] = { name, color };
        });
        console.log('Получены курьеры:', couriers);
        updateLegend();
      }
    };

    ws.onerror = (error) => console.error('Ошибка WebSocket:', error);
    ws.onclose = () => console.log('WebSocket для карты отключён');
  </script>
</body>
</html>